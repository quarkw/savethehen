<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Save The Hen Signatures</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #20201F;
      color: #f5f5f5;
    }
    #container {
      text-align: center;
      padding: 2em;
      border-radius: 8px;
      background-color: transparent;
      box-shadow: none;
    }
    #cell-value {
      font-size: 4em;
      font-weight: bold;
    }
    header {
      margin-bottom: 1em;
    }
    header img {
        max-width: 100%;
        height: auto;
        max-height: 150px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
</head>
<body>
  <div id="container">
    <header>
        <img src="images/NEW+LOGO+NO+YEAR+fnqc2.png" alt="Logo">
        <h1 id="title">Save The Hen Signatures</h1>
    </header>
    <div id="cell-value">Loading...</div>
  </div>

  <script>
    const SPREADSHEET_ID = '1TowJS-Jm8i3lxhNwd1V5noBGfY_C7b96x7Jc8NqzoDY';
    const RANGE = 'A1';
    let pollInterval = 5000; // 5 seconds
    let lastValue = null;
    let bigCelebrationDone = false;

    async function fetchAndUpdate() {
      const params = new URLSearchParams(window.location.search);
      const apiKey = params.get('apiKey');
      const smallCelebrationInterval = params.get('smallCelebrationInterval');
      const bigCelebrationCount = params.get('bigCelebrationCount') || 10000;
      const title = params.get('title');
      const countAffix = params.get('countAffix') || '';

      if (params.has('title')) {
        if (title && title !== '') {
            document.getElementById('title').textContent = title;
            document.title = title;
        } else {
            document.getElementById('title').style.display = 'none';
        }
      }

      if (!apiKey) {
        // Don't show error to user, but stop trying.
        if (document.getElementById('cell-value').textContent === 'Loading...') {
            document.getElementById('cell-value').textContent = 'Error';
        }
        console.error('apiKey query param is required.');
        return;
      }

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${apiKey}`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Google Sheets API error: ${response.statusText}`);
        }
        const data = await response.json();
        const value = data.values[0][0];
        const numericValue = parseInt(value.replace(/,/g, ''), 10);

        if (lastValue !== value) {
            document.getElementById('cell-value').textContent = value + countAffix;

            if (lastValue !== null) { // Don't celebrate on first load for small celebration
                if (smallCelebrationInterval && numericValue / parseInt(smallCelebrationInterval, 10) > lastValue / parseInt(smallCelebrationInterval, 10)) {
                    smallCelebration();
                }
            }
            
            if (!bigCelebrationDone && numericValue >= parseInt(bigCelebrationCount, 10)) {
                bigCelebration();
                bigCelebrationDone = true;
            }

            lastValue = numericValue;
        }
        
        pollInterval = 5000; // Reset interval on success
      } catch (error) {
        console.error(error);
        pollInterval += 5000; // Increase interval on failure
      } finally {
        setTimeout(fetchAndUpdate, pollInterval);
      }
    }

    function smallCelebration() {
      const defaults = {
        spread: 360,
        ticks: 100,
        gravity: 0,
        decay: 0.94,
        startVelocity: 30,
      };

      function shoot() {
        confetti({
          ...defaults,
          particleCount: 30,
          scalar: 1.2,
          shapes: ["circle", "square"],
          colors: ["#a864fd", "#29cdff", "#78ff44", "#ff718d", "#fdff6a"],
        });

        confetti({
          ...defaults,
          particleCount: 10,
          decay: .98,
          scalar: 10,
          shapes: [
            // "emoji",
            "image"
          ],
          shapeOptions: {
            // emoji: {
            //   value: ["üêî", "üê£"],
            // },
            image: [{
              src: "images/hen-coin.png",
              width: 32,
              height: 32,
            },
            {
              src: "images/emoji-chicken.png",
              width: 32,
              height: 32,
            }]
          },
        });
      }

      setTimeout(shoot, 0);
      setTimeout(shoot, 100);
      setTimeout(shoot, 200);
    }

    function bigCelebration() {
        const duration = 15 * 1000,
        animationEnd = Date.now() + duration,
        defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) {
          return clearInterval(interval);
        }

        const particleCount = 50 * (timeLeft / duration);

        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
      }, 250);
    }

    fetchAndUpdate();
  </script>
</body>
</html>